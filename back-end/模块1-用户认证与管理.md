# æ¨¡å—1ï¼šç”¨æˆ·è®¤è¯ä¸ç®¡ç†æ¨¡å— - å®ç°æ–‡æ¡£

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**: ç”¨æˆ·è®¤è¯ä¸ç®¡ç†æ¨¡å—
**ä¾èµ–æ¨¡å—**: æ¨¡å—0ï¼ˆé¡¹ç›®åŸºç¡€æ¶æ„ï¼‰
**å¼€å‘å‘¨æœŸ**: 3-4å¤©
**æ ¸å¿ƒåŠŸèƒ½**: Web3é’±åŒ…è®¤è¯ã€JWT Tokenç®¡ç†ã€ç”¨æˆ·èµ„æ–™ç®¡ç†

---

## ğŸ¯ åŠŸèƒ½æ¸…å•

### 1. é’±åŒ…è®¤è¯
- [x] ç”Ÿæˆç™»å½•æ¶ˆæ¯ï¼ˆNonceï¼‰
- [x] éªŒè¯é’±åŒ…ç­¾å
- [x] é’±åŒ…åœ°å€éªŒè¯å·¥å…·
- [x] é˜²é‡æ”¾æ”»å‡»æœºåˆ¶

### 2. JWT Token ç®¡ç†
- [x] Access Token ç”Ÿæˆ
- [x] Refresh Token ç”Ÿæˆ
- [x] Token éªŒè¯
- [x] Token åˆ·æ–°
- [x] JWT è®¤è¯ä¸­é—´ä»¶

### 3. ç”¨æˆ·ç®¡ç†
- [x] ç”¨æˆ·æ³¨å†Œï¼ˆé¦–æ¬¡ç™»å½•è‡ªåŠ¨åˆ›å»ºï¼‰
- [x] ç”¨æˆ·èµ„æ–™æŸ¥è¯¢
- [x] ç”¨æˆ·èµ„æ–™æ›´æ–°
- [x] ç”¨æˆ·ç»Ÿè®¡æ•°æ®

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### 1. æ‰©å±• users è¡¨

```sql
-- åœ¨ç°æœ‰ users è¡¨åŸºç¡€ä¸Šæ·»åŠ å­—æ®µ
ALTER TABLE `users`
ADD COLUMN `avatar_url` VARCHAR(255) DEFAULT NULL COMMENT 'å¤´åƒURL' AFTER `username`,
ADD COLUMN `email` VARCHAR(100) DEFAULT NULL COMMENT 'é‚®ç®±' AFTER `avatar_url`,
ADD COLUMN `bio` TEXT DEFAULT NULL COMMENT 'ä¸ªäººç®€ä»‹' AFTER `email`,
ADD COLUMN `total_trades` INT UNSIGNED DEFAULT 0 COMMENT 'æ€»äº¤æ˜“æ¬¡æ•°' AFTER `bio`,
ADD COLUMN `total_volume` DECIMAL(20,8) DEFAULT 0 COMMENT 'æ€»äº¤æ˜“é‡' AFTER `total_trades`,
ADD COLUMN `total_profit` DECIMAL(20,8) DEFAULT 0 COMMENT 'æ€»æ”¶ç›Š' AFTER `total_volume`,
ADD COLUMN `win_count` INT UNSIGNED DEFAULT 0 COMMENT 'èƒœåˆ©æ¬¡æ•°' AFTER `total_profit`,
ADD COLUMN `lose_count` INT UNSIGNED DEFAULT 0 COMMENT 'å¤±è´¥æ¬¡æ•°' AFTER `win_count`,
ADD COLUMN `status` TINYINT UNSIGNED DEFAULT 0 COMMENT 'çŠ¶æ€: 0-æ­£å¸¸ 1-ç¦ç”¨' AFTER `lose_count`,
ADD COLUMN `last_login_at` TIMESTAMP NULL DEFAULT NULL COMMENT 'æœ€åç™»å½•æ—¶é—´' AFTER `status`,
ADD INDEX `idx_username` (`username`),
ADD INDEX `idx_created_at` (`created_at`);
```

### 2. åˆ›å»º auth_nonces è¡¨ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰

```sql
CREATE TABLE IF NOT EXISTS `auth_nonces` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `wallet_address` VARCHAR(42) NOT NULL COMMENT 'é’±åŒ…åœ°å€',
  `nonce` VARCHAR(64) NOT NULL COMMENT 'éšæœºæ•°',
  `expires_at` TIMESTAMP NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  `used` TINYINT UNSIGNED DEFAULT 0 COMMENT 'æ˜¯å¦å·²ä½¿ç”¨: 0-æœªä½¿ç”¨ 1-å·²ä½¿ç”¨',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_nonce` (`nonce`),
  KEY `idx_wallet_address` (`wallet_address`),
  KEY `idx_expires_at` (`expires_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è®¤è¯éšæœºæ•°è¡¨';
```

### 3. åˆ›å»º refresh_tokens è¡¨

```sql
CREATE TABLE IF NOT EXISTS `refresh_tokens` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
  `token` VARCHAR(255) NOT NULL COMMENT 'Refresh Token',
  `expires_at` TIMESTAMP NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_token` (`token`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_expires_at` (`expires_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='åˆ·æ–°ä»¤ç‰Œè¡¨';
```

---

## ğŸ”Œ API æ¥å£è®¾è®¡

### 1. è·å–ç™»å½•æ¶ˆæ¯ï¼ˆNonceï¼‰

**æ¥å£**: `POST /api/v1/auth/nonce`

**è¯·æ±‚å‚æ•°**:
```json
{
  "wallet_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
}
```

**å“åº”æ•°æ®**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "nonce": "Sign this message to login: 1a2b3c4d5e6f...",
    "expires_at": "2026-01-04T12:30:00Z"
  },
  "timestamp": 1704355200
}
```

### 2. é’±åŒ…ç™»å½•

**æ¥å£**: `POST /api/v1/auth/login`

**è¯·æ±‚å‚æ•°**:
```json
{
  "wallet_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
  "signature": "0x1234567890abcdef...",
  "nonce": "Sign this message to login: 1a2b3c4d5e6f..."
}
```

**å“åº”æ•°æ®**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 86400,
    "user": {
      "id": 1,
      "wallet_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
      "username": "User123",
      "avatar_url": null,
      "created_at": "2026-01-04T00:00:00Z"
    }
  },
  "timestamp": 1704355200
}


### 3. åˆ·æ–° Token

**æ¥å£**: `POST /api/v1/auth/refresh`

**è¯·æ±‚å‚æ•°**:
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIs..."
}
```

**å“åº”æ•°æ®**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 86400
  },
  "timestamp": 1704355200
}
```

### 4. ç™»å‡º

**æ¥å£**: `POST /api/v1/auth/logout`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer {access_token}
```

**å“åº”æ•°æ®**:
```json
{
  "code": 0,
  "msg": "success",
  "timestamp": 1704355200
}
```

### 5. è·å–ç”¨æˆ·èµ„æ–™

**æ¥å£**: `GET /api/v1/user/profile`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer {access_token}
```

**å“åº”æ•°æ®**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": 1,
    "wallet_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "username": "User123",
    "avatar_url": "https://example.com/avatar.jpg",
    "email": "user@example.com",
    "bio": "Crypto enthusiast",
    "created_at": "2026-01-04T00:00:00Z",
    "last_login_at": "2026-01-04T10:00:00Z",
    "stats": {
      "total_trades": 156,
      "total_volume": 85000.00,
      "total_profit": 12500.50,
      "win_count": 105,
      "lose_count": 51,
      "win_rate": 67.31
    }
  },
  "timestamp": 1704355200
}
```

### 6. æ›´æ–°ç”¨æˆ·èµ„æ–™

**æ¥å£**: `PUT /api/v1/user/profile`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer {access_token}
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "username": "NewUsername",
  "avatar_url": "https://example.com/new-avatar.jpg",
  "email": "newemail@example.com",
  "bio": "Updated bio"
}
```

**å“åº”æ•°æ®**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": 1,
    "wallet_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "username": "NewUsername",
    "avatar_url": "https://example.com/new-avatar.jpg",
    "email": "newemail@example.com",
    "bio": "Updated bio",
    "updated_at": "2026-01-04T11:00:00Z"
  },
  "timestamp": 1704355200
}
```

### 7. æŸ¥è¯¢å…¶ä»–ç”¨æˆ·ä¿¡æ¯

**æ¥å£**: `GET /api/v1/user/:address`

**è·¯å¾„å‚æ•°**:
- `address`: é’±åŒ…åœ°å€

**å“åº”æ•°æ®**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "wallet_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "username": "User123",
    "avatar_url": "https://example.com/avatar.jpg",
    "bio": "Crypto enthusiast",
    "created_at": "2026-01-04T00:00:00Z",
    "stats": {
      "total_trades": 156,
      "win_rate": 67.31
    }
  },
  "timestamp": 1704355200
}
```

---

## ğŸ”§ æ ¸å¿ƒä»£ç å®ç°

### 1. æ•°æ®æ¨¡å‹ (internal/model/user.go)

```go
package model

import "time"

// User ç”¨æˆ·æ¨¡å‹
type User struct {
	ID            uint64     `gorm:"primaryKey;autoIncrement" json:"id"`
	WalletAddress string     `gorm:"type:varchar(42);uniqueIndex:uk_wallet_address;not null" json:"wallet_address"`
	Username      *string    `gorm:"type:varchar(50);index:idx_username" json:"username"`
	AvatarURL     *string    `gorm:"type:varchar(255)" json:"avatar_url"`
	Email         *string    `gorm:"type:varchar(100)" json:"email"`
	Bio           *string    `gorm:"type:text" json:"bio"`
	TotalTrades   uint       `gorm:"type:int unsigned;default:0" json:"total_trades"`
	TotalVolume   float64    `gorm:"type:decimal(20,8);default:0" json:"total_volume"`
	TotalProfit   float64    `gorm:"type:decimal(20,8);default:0" json:"total_profit"`
	WinCount      uint       `gorm:"type:int unsigned;default:0" json:"win_count"`
	LoseCount     uint       `gorm:"type:int unsigned;default:0" json:"lose_count"`
	Status        uint8      `gorm:"type:tinyint unsigned;default:0" json:"status"`
	LastLoginAt   *time.Time `gorm:"type:timestamp" json:"last_login_at"`
	CreatedAt     time.Time  `gorm:"type:timestamp;default:CURRENT_TIMESTAMP" json:"created_at"`
	UpdatedAt     time.Time  `gorm:"type:timestamp;default:CURRENT_TIMESTAMP" json:"updated_at"`
}

func (User) TableName() string {
	return "users"
}

```

// AuthNonce è®¤è¯éšæœºæ•°æ¨¡å‹
type AuthNonce struct {
	ID            uint64    `gorm:"primaryKey;autoIncrement" json:"id"`
	WalletAddress string    `gorm:"type:varchar(42);index:idx_wallet_address;not null" json:"wallet_address"`
	Nonce         string    `gorm:"type:varchar(64);uniqueIndex:uk_nonce;not null" json:"nonce"`
	ExpiresAt     time.Time `gorm:"type:timestamp;index:idx_expires_at;not null" json:"expires_at"`
	Used          uint8     `gorm:"type:tinyint unsigned;default:0" json:"used"`
	CreatedAt     time.Time `gorm:"type:timestamp;default:CURRENT_TIMESTAMP" json:"created_at"`
}

func (AuthNonce) TableName() string {
	return "auth_nonces"
}

// RefreshToken åˆ·æ–°ä»¤ç‰Œæ¨¡å‹
type RefreshToken struct {
	ID        uint64    `gorm:"primaryKey;autoIncrement" json:"id"`
	UserID    uint64    `gorm:"type:bigint unsigned;index:idx_user_id;not null" json:"user_id"`
	Token     string    `gorm:"type:varchar(255);uniqueIndex:uk_token;not null" json:"token"`
	ExpiresAt time.Time `gorm:"type:timestamp;index:idx_expires_at;not null" json:"expires_at"`
	CreatedAt time.Time `gorm:"type:timestamp;default:CURRENT_TIMESTAMP" json:"created_at"`
}

func (RefreshToken) TableName() string {
	return "refresh_tokens"
}
```

### 2. JWT å·¥å…· (internal/utils/jwt.go)

```go
package utils

import (
	"errors"
	"time"

	"github.com/golang-jwt/jwt/v5"
)

// JWTClaims JWT å£°æ˜
type JWTClaims struct {
	UserID        uint64 `json:"user_id"`
	WalletAddress string `json:"wallet_address"`
	jwt.RegisteredClaims
}

// GenerateToken ç”Ÿæˆ Access Token
func GenerateToken(userID uint64, walletAddress string, secret string, expireSeconds int64) (string, error) {
	claims := JWTClaims{
		UserID:        userID,
		WalletAddress: walletAddress,
		RegisteredClaims: jwt.RegisteredClaims{
			ExpiresAt: jwt.NewNumericDate(time.Now().Add(time.Duration(expireSeconds) * time.Second)),
			IssuedAt:  jwt.NewNumericDate(time.Now()),
			NotBefore: jwt.NewNumericDate(time.Now()),
		},
	}

	token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
	return token.SignedString([]byte(secret))
}

// ParseToken è§£æ Token
func ParseToken(tokenString string, secret string) (*JWTClaims, error) {
	token, err := jwt.ParseWithClaims(tokenString, &JWTClaims{}, func(token *jwt.Token) (interface{}, error) {
		return []byte(secret), nil
	})

	if err != nil {
		return nil, err
	}

	if claims, ok := token.Claims.(*JWTClaims); ok && token.Valid {
		return claims, nil
	}

	return nil, errors.New("invalid token")
}
```

### 3. Web3 ç­¾åéªŒè¯å·¥å…· (internal/utils/web3.go)

```go
package utils

import (
	"crypto/ecdsa"
	"errors"
	"fmt"
	"strings"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/crypto"
)

// VerifySignature éªŒè¯ä»¥å¤ªåŠç­¾å
func VerifySignature(message, signature, address string) (bool, error) {
	// æ ‡å‡†åŒ–åœ°å€æ ¼å¼
	if !strings.HasPrefix(address, "0x") {
		address = "0x" + address
	}
	if !common.IsHexAddress(address) {
		return false, errors.New("invalid ethereum address")
	}

	// è§£ç ç­¾å
	sig, err := hexutil.Decode(signature)
	if err != nil {
		return false, fmt.Errorf("failed to decode signature: %w", err)
	}

	// ç­¾åé•¿åº¦å¿…é¡»æ˜¯ 65 å­—èŠ‚
	if len(sig) != 65 {
		return false, errors.New("invalid signature length")
	}

	// è°ƒæ•´ v å€¼ï¼ˆMetaMask ç­¾åçš„ v å€¼æ˜¯ 27 æˆ– 28ï¼‰
	if sig[64] >= 27 {
		sig[64] -= 27
	}

	// æ„é€ ä»¥å¤ªåŠç­¾åæ¶ˆæ¯
	hash := crypto.Keccak256Hash([]byte(fmt.Sprintf("\x19Ethereum Signed Message:\n%d%s", len(message), message)))

	// æ¢å¤å…¬é’¥
	pubKey, err := crypto.SigToPub(hash.Bytes(), sig)
	if err != nil {
		return false, fmt.Errorf("failed to recover public key: %w", err)
	}

	// ä»å…¬é’¥æ¢å¤åœ°å€
	recoveredAddr := crypto.PubkeyToAddress(*pubKey)

	// æ¯”è¾ƒåœ°å€
	return strings.EqualFold(recoveredAddr.Hex(), address), nil
}

// IsValidAddress éªŒè¯ä»¥å¤ªåŠåœ°å€æ ¼å¼
func IsValidAddress(address string) bool {
	return common.IsHexAddress(address)
}

// NormalizeAddress æ ‡å‡†åŒ–åœ°å€æ ¼å¼
func NormalizeAddress(address string) string {
	if !strings.HasPrefix(address, "0x") {
		address = "0x" + address
	}
	return strings.ToLower(address)
}
```

### 4. éšæœºæ•°ç”Ÿæˆå·¥å…· (internal/utils/nonce.go)

```go
package utils

import (
	"crypto/rand"
	"encoding/hex"
	"fmt"
)

// GenerateNonce ç”Ÿæˆç™»å½•éšæœºæ•°
func GenerateNonce() (string, error) {
	bytes := make([]byte, 32)
	if _, err := rand.Read(bytes); err != nil {
		return "", err
	}
	return hex.EncodeToString(bytes), nil
}

// GenerateLoginMessage ç”Ÿæˆç™»å½•æ¶ˆæ¯
func GenerateLoginMessage(nonce string) string {
	return fmt.Sprintf("Sign this message to login: %s", nonce)
}
```


