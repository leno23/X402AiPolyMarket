# æ¨¡å—1ï¼šç”¨æˆ·è®¤è¯ä¸ç®¡ç†æ¨¡å— - éªŒæ”¶æ¸…å•

## âœ… å®Œæˆæƒ…å†µæ€»è§ˆ

### å·²åˆ›å»ºçš„æ–‡ä»¶

#### æ•°æ®åº“è„šæœ¬
- [x] `scripts/module1_init_db.sql` - æ¨¡å—1æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

#### æ•°æ®æ¨¡å‹
- [x] `internal/model/user.go` - ç”¨æˆ·ã€è®¤è¯éšæœºæ•°ã€åˆ·æ–°ä»¤ç‰Œæ¨¡å‹

#### å·¥å…·ç±»
- [x] `internal/utils/jwt.go` - JWT Token ç”Ÿæˆå’Œè§£æ
- [x] `internal/utils/web3.go` - Web3 ç­¾åéªŒè¯
- [x] `internal/utils/nonce.go` - éšæœºæ•°ç”Ÿæˆ
- [x] `internal/utils/response.go` - æ·»åŠ è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼ˆå·²æ›´æ–°ï¼‰

#### ä¸­é—´ä»¶
- [x] `internal/middleware/auth_middleware.go` - JWT è®¤è¯ä¸­é—´ä»¶

#### ç±»å‹å®šä¹‰
- [x] `internal/types/auth_types.go` - è®¤è¯å’Œç”¨æˆ·ç›¸å…³ç±»å‹å®šä¹‰

#### Logic å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
- [x] `internal/logic/auth/nonce_logic.go` - è·å–Nonceé€»è¾‘
- [x] `internal/logic/auth/login_logic.go` - ç™»å½•é€»è¾‘
- [x] `internal/logic/auth/refresh_logic.go` - åˆ·æ–°Tokené€»è¾‘
- [x] `internal/logic/auth/logout_logic.go` - ç™»å‡ºé€»è¾‘
- [x] `internal/logic/user/profile_logic.go` - ç”¨æˆ·èµ„æ–™é€»è¾‘
- [x] `internal/logic/user/public_user_logic.go` - å…¬å¼€ç”¨æˆ·ä¿¡æ¯é€»è¾‘

#### Handler å±‚ï¼ˆHTTPå¤„ç†å™¨ï¼‰
- [x] `internal/handler/auth/nonce_handler.go` - Nonceæ¥å£
- [x] `internal/handler/auth/login_handler.go` - ç™»å½•æ¥å£
- [x] `internal/handler/auth/refresh_handler.go` - åˆ·æ–°Tokenæ¥å£
- [x] `internal/handler/auth/logout_handler.go` - ç™»å‡ºæ¥å£
- [x] `internal/handler/user/profile_handler.go` - ç”¨æˆ·èµ„æ–™æ¥å£
- [x] `internal/handler/user/public_user_handler.go` - å…¬å¼€ç”¨æˆ·ä¿¡æ¯æ¥å£

#### è·¯ç”±é…ç½®
- [x] `internal/handler/routes.go` - è·¯ç”±æ³¨å†Œï¼ˆå·²æ›´æ–°ï¼‰

#### æ–‡æ¡£
- [x] `back-end/æ¨¡å—1-ç”¨æˆ·è®¤è¯ä¸ç®¡ç†.md` - è¯¦ç»†å®ç°æ–‡æ¡£

---

## ğŸ§ª éªŒæ”¶æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: å®‰è£…é¢å¤–ä¾èµ–

```bash
cd back-end/PolyMarket

# å®‰è£… gorilla/muxï¼ˆç”¨äºè·¯å¾„å‚æ•°ï¼‰
go get -u github.com/gorilla/mux
go mod tidy
```

### æ­¥éª¤ 2: åˆå§‹åŒ–æ•°æ®åº“

```bash
# æ‰§è¡Œæ¨¡å—1çš„æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
mysql -u root -p < scripts/module1_init_db.sql
```

**é¢„æœŸç»“æœ**:
- users è¡¨æ–°å¢å­—æ®µæˆåŠŸ
- auth_nonces è¡¨åˆ›å»ºæˆåŠŸ
- refresh_tokens è¡¨åˆ›å»ºæˆåŠŸ

**éªŒè¯**:
```bash
mysql -u root -p -e "USE polymarket; SHOW TABLES;"
mysql -u root -p -e "USE polymarket; DESC users;"
mysql -u root -p -e "USE polymarket; DESC auth_nonces;"
mysql -u root -p -e "USE polymarket; DESC refresh_tokens;"
```

### æ­¥éª¤ 3: å¯åŠ¨æœåŠ¡

```bash
go run polymarket.go -f etc/polymarket-api.yaml
```

**é¢„æœŸè¾“å‡º**:
```
Starting server at 0.0.0.0:8888...
```

---

## ğŸ“ API æµ‹è¯•

### æµ‹è¯• 1: è·å–ç™»å½• Nonce

```bash
curl -X POST http://localhost:8888/api/v1/auth/nonce \
  -H "Content-Type: application/json" \
  -d '{
    "wallet_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "nonce": "Sign this message to login: 1a2b3c4d...",
    "expires_at": "2026-01-04T12:30:00Z"
  },
  "timestamp": 1704355200
}
```

**æ£€æŸ¥ç‚¹**:
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] `code` ä¸º 0
- [ ] `nonce` å­—æ®µå­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
- [ ] `expires_at` ä¸ºæœªæ¥æ—¶é—´

### æµ‹è¯• 2: é’±åŒ…ç™»å½•ï¼ˆéœ€è¦å‰ç«¯ç­¾åï¼‰

**æ³¨æ„**: æ­¤æµ‹è¯•éœ€è¦ä½¿ç”¨ MetaMask æˆ–å…¶ä»–é’±åŒ…å¯¹ nonce è¿›è¡Œç­¾åã€‚

```bash
# ç¤ºä¾‹ï¼ˆéœ€è¦æ›¿æ¢ä¸ºå®é™…ç­¾åï¼‰
curl -X POST http://localhost:8888/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "wallet_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "signature": "0x1234567890abcdef...",
    "nonce": "Sign this message to login: 1a2b3c4d..."
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 86400,
    "user": {
      "id": 1,


### æµ‹è¯• 5: åˆ·æ–° Token

```bash
curl -X POST http://localhost:8888/api/v1/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refresh_token": "{refresh_token}"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 86400
  },
  "timestamp": 1704355200
}
```

**æ£€æŸ¥ç‚¹**:
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] è¿”å›æ–°çš„ access_token
- [ ] æ–° token å¯ä»¥æ­£å¸¸ä½¿ç”¨

### æµ‹è¯• 6: æŸ¥è¯¢å…¶ä»–ç”¨æˆ·ä¿¡æ¯

```bash
curl -X GET http://localhost:8888/api/v1/user/0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "wallet_address": "0x742d35cc6634c0532925a3b844bc9e7595f0beb",
    "username": "TestUser",
    "bio": "Hello Web3!",
    "created_at": "2026-01-04T00:00:00Z",
    "stats": {
      "total_trades": 0,
      "win_rate": 0
    }
  },
  "timestamp": 1704355200
}
```

**æ£€æŸ¥ç‚¹**:
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] è¿”å›å…¬å¼€ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
- [ ] æ— éœ€è®¤è¯å³å¯è®¿é—®

### æµ‹è¯• 7: ç™»å‡º

```bash
curl -X POST http://localhost:8888/api/v1/auth/logout \
  -H "Authorization: Bearer {access_token}"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "msg": "success",
  "timestamp": 1704355200
}
```

**æ£€æŸ¥ç‚¹**:
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] æ•°æ®åº“ä¸­ refresh_token è¢«åˆ é™¤
- [ ] æ—§çš„ refresh_token æ— æ³•å†ä½¿ç”¨

### æµ‹è¯• 8: æœªè®¤è¯è®¿é—®å—ä¿æŠ¤æ¥å£

```bash
curl -X GET http://localhost:8888/api/v1/user/profile
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 1002,
  "msg": "Missing authorization header",
  "timestamp": 1704355200
}
```

**æ£€æŸ¥ç‚¹**:
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] `code` ä¸º 1002ï¼ˆæœªæˆæƒï¼‰
- [ ] è¿”å›é”™è¯¯ä¿¡æ¯

### æµ‹è¯• 9: æ— æ•ˆ Token

```bash
curl -X GET http://localhost:8888/api/v1/user/profile \
  -H "Authorization: Bearer invalid_token"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 1002,
  "msg": "Invalid or expired token",
  "timestamp": 1704355200
}
```

**æ£€æŸ¥ç‚¹**:
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] `code` ä¸º 1002
- [ ] è¿”å›é”™è¯¯ä¿¡æ¯

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### å¿…é¡»é€šè¿‡çš„æ£€æŸ¥é¡¹

#### åŠŸèƒ½å®Œæ•´æ€§
- [ ] âœ… è·å– Nonce æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] âœ… é’±åŒ…ç™»å½•æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] âœ… ç­¾åéªŒè¯æ­£ç¡®
- [ ] âœ… JWT Token ç”Ÿæˆå’ŒéªŒè¯æ­£å¸¸
- [ ] âœ… Refresh Token æœºåˆ¶æ­£å¸¸
- [ ] âœ… ç”¨æˆ·èµ„æ–™æŸ¥è¯¢æ­£å¸¸
- [ ] âœ… ç”¨æˆ·èµ„æ–™æ›´æ–°æ­£å¸¸
- [ ] âœ… å…¬å¼€ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢æ­£å¸¸
- [ ] âœ… ç™»å‡ºåŠŸèƒ½æ­£å¸¸

#### å®‰å…¨æ€§
- [ ] âœ… Nonce é˜²é‡æ”¾æ”»å‡»æœºåˆ¶æœ‰æ•ˆ
- [ ] âœ… ç­¾åéªŒè¯ä¸¥æ ¼
- [ ] âœ… JWT è®¤è¯ä¸­é—´ä»¶æ­£å¸¸å·¥ä½œ
- [ ] âœ… å—ä¿æŠ¤æ¥å£éœ€è¦è®¤è¯
- [ ] âœ… æ— æ•ˆ Token è¢«æ‹’ç»
- [ ] âœ… è¿‡æœŸ Token è¢«æ‹’ç»

#### æ•°æ®åº“
- [ ] âœ… users è¡¨å­—æ®µå®Œæ•´
- [ ] âœ… auth_nonces è¡¨åˆ›å»ºæˆåŠŸ
- [ ] âœ… refresh_tokens è¡¨åˆ›å»ºæˆåŠŸ
- [ ] âœ… ç”¨æˆ·æ•°æ®æ­£ç¡®ä¿å­˜
- [ ] âœ… Nonce æ­£ç¡®æ ‡è®°ä¸ºå·²ä½¿ç”¨
- [ ] âœ… Refresh Token æ­£ç¡®ä¿å­˜å’Œåˆ é™¤

#### ä»£ç è´¨é‡
- [ ] âœ… ä»£ç æ— ç¼–è¯‘é”™è¯¯
- [ ] âœ… ä»£ç æ— è¿è¡Œæ—¶é”™è¯¯
- [ ] âœ… é”™è¯¯å¤„ç†å®Œå–„
- [ ] âœ… æ—¥å¿—è®°å½•å®Œæ•´
- [ ] âœ… ä»£ç ç»“æ„æ¸…æ™°

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: gorilla/mux æœªå®‰è£…

**é”™è¯¯ä¿¡æ¯**: `cannot find package "github.com/gorilla/mux"`

**è§£å†³æ–¹æ¡ˆ**:
```bash
go get -u github.com/gorilla/mux
go mod tidy
```

### é—®é¢˜ 2: æ•°æ®åº“è¡¨ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**: `Table 'polymarket.auth_nonces' doesn't exist`

**è§£å†³æ–¹æ¡ˆ**:
```bash
mysql -u root -p < scripts/module1_init_db.sql
```

### é—®é¢˜ 3: JWT ç­¾åéªŒè¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `Invalid or expired token`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„ AccessSecret æ˜¯å¦æ­£ç¡®
2. ç¡®ä¿ Token æ²¡æœ‰è¿‡æœŸ
3. ç¡®ä¿ Authorization å¤´æ ¼å¼æ­£ç¡®ï¼š`Bearer {token}`

### é—®é¢˜ 4: Web3 ç­¾åéªŒè¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `Invalid signature`

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ nonce è¿›è¡Œç­¾å
2. ç¡®ä¿é’±åŒ…åœ°å€ä¸ç­¾ååœ°å€ä¸€è‡´
3. ç¡®ä¿ç­¾åæ ¼å¼æ­£ç¡®ï¼ˆ0xå¼€å¤´çš„åå…­è¿›åˆ¶ï¼‰

---

## ğŸ‰ éªŒæ”¶é€šè¿‡æ ‡å‡†

å½“ä»¥ä¸Šæ‰€æœ‰æ£€æŸ¥é¡¹éƒ½é€šè¿‡æ—¶ï¼Œæ¨¡å—1éªŒæ”¶é€šè¿‡ï¼

**ä¸‹ä¸€æ­¥**: å¼€å§‹ **æ¨¡å—2ï¼šå¸‚åœºç®¡ç†æ¨¡å—** çš„å¼€å‘

---

## ğŸ“ å¤‡æ³¨

- æœ¬æ¨¡å—å®ç°äº†å®Œæ•´çš„ Web3 é’±åŒ…è®¤è¯æµç¨‹
- JWT Token æœºåˆ¶ç¬¦åˆè¡Œä¸šæ ‡å‡†
- ç­¾åéªŒè¯ä½¿ç”¨ä»¥å¤ªåŠæ ‡å‡†
- é˜²é‡æ”¾æ”»å‡»æœºåˆ¶æœ‰æ•ˆ
- å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒ `back-end/æ¨¡å—1-ç”¨æˆ·è®¤è¯ä¸ç®¡ç†.md` æˆ–æé—®

      "wallet_address": "0x742d35cc6634c0532925a3b844bc9e7595f0beb",
      "username": null,
      "avatar_url": null,
      "created_at": "2026-01-04T00:00:00Z"
    }
  },
  "timestamp": 1704355200
}
```

**æ£€æŸ¥ç‚¹**:
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] `access_token` å’Œ `refresh_token` å­˜åœ¨
- [ ] ç”¨æˆ·ä¿¡æ¯æ­£ç¡®
- [ ] æ•°æ®åº“ä¸­åˆ›å»ºäº†æ–°ç”¨æˆ·è®°å½•

### æµ‹è¯• 3: è·å–ç”¨æˆ·èµ„æ–™ï¼ˆéœ€è¦è®¤è¯ï¼‰

```bash
# ä½¿ç”¨ä¸Šä¸€æ­¥è·å–çš„ access_token
curl -X GET http://localhost:8888/api/v1/user/profile \
  -H "Authorization: Bearer {access_token}"
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": 1,
    "wallet_address": "0x742d35cc6634c0532925a3b844bc9e7595f0beb",
    "username": null,
    "created_at": "2026-01-04T00:00:00Z",
    "stats": {
      "total_trades": 0,
      "total_volume": 0,
      "total_profit": 0,
      "win_count": 0,
      "lose_count": 0,
      "win_rate": 0
    }
  },
  "timestamp": 1704355200
}
```

**æ£€æŸ¥ç‚¹**:
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] è¿”å›å½“å‰ç”¨æˆ·ä¿¡æ¯
- [ ] ç»Ÿè®¡æ•°æ®æ­£ç¡®

### æµ‹è¯• 4: æ›´æ–°ç”¨æˆ·èµ„æ–™

```bash
curl -X PUT http://localhost:8888/api/v1/user/profile \
  -H "Authorization: Bearer {access_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "TestUser",
    "bio": "Hello Web3!"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": 1,
    "wallet_address": "0x742d35cc6634c0532925a3b844bc9e7595f0beb",
    "username": "TestUser",
    "bio": "Hello Web3!",
    "updated_at": "2026-01-04T11:00:00Z"
  },
  "timestamp": 1704355200
}
```

**æ£€æŸ¥ç‚¹**:
- [ ] HTTP çŠ¶æ€ç ä¸º 200
- [ ] ç”¨æˆ·åå’Œç®€ä»‹æ›´æ–°æˆåŠŸ
- [ ] æ•°æ®åº“ä¸­æ•°æ®å·²æ›´æ–°

