# X402AiPolyMarket 后端开发路线图

## 🎯 项目目标

构建一个完整的、高性能的、安全可靠的AI预测市场后端系统，支持：
- 用户钱包认证与管理
- 预测市场创建与交易
- AI智能预测分析
- 区块链智能合约交互
- 实时数据推送
- 完善的管理后台

---

## 📅 开发阶段规划

### 第一阶段：基础设施搭建 (Week 1-2)

#### 1.1 项目初始化
- [x] go-zero框架搭建
- [ ] 项目目录结构规范
- [ ] 配置文件管理（开发/测试/生产环境）
- [ ] 日志系统配置
- [ ] 错误处理机制

**任务清单**:
```bash
# 1. 创建项目结构
back-end/PolyMarket/
├── api/              # API定义文件
├── internal/
│   ├── config/       # 配置
│   ├── handler/      # HTTP处理器
│   ├── logic/        # 业务逻辑
│   ├── svc/          # 服务上下文
│   ├── types/        # 类型定义
│   ├── model/        # 数据模型
│   ├── middleware/   # 中间件
│   └── utils/        # 工具函数
├── etc/              # 配置文件
└── scripts/          # 脚本文件

# 2. 安装依赖
go get -u gorm.io/gorm
go get -u gorm.io/driver/mysql
go get -u github.com/go-redis/redis/v8
go get -u github.com/ethereum/go-ethereum
go get -u github.com/golang-jwt/jwt/v4
```

#### 1.2 数据库搭建
- [ ] MySQL数据库安装与配置
- [ ] Redis缓存安装与配置
- [ ] 数据库表结构创建
- [ ] 初始化数据导入
- [ ] 数据库连接池配置

**SQL脚本**:
```bash
# 创建数据库
CREATE DATABASE polymarket DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 执行建表脚本
mysql -u root -p polymarket < scripts/init_tables.sql

# 导入初始数据
mysql -u root -p polymarket < scripts/init_data.sql
```

#### 1.3 区块链环境
- [ ] 本地测试网络搭建（Hardhat）
- [ ] 智能合约部署
- [ ] go-ethereum库集成
- [ ] 合约ABI生成与绑定

---

### 第二阶段：核心功能开发 (Week 3-6)

#### 2.1 用户认证模块 (Week 3)

**功能点**:
- [ ] 钱包签名验证
- [ ] JWT Token生成与验证
- [ ] 用户注册/登录
- [ ] Token刷新机制
- [ ] 登出功能

**API接口**:
```
POST /api/v1/auth/login
POST /api/v1/auth/refresh
POST /api/v1/auth/logout
GET  /api/v1/user/profile
PUT  /api/v1/user/profile
```

**技术要点**:
```go
// 1. 签名验证
func VerifySignature(address, message, signature string) bool

// 2. JWT生成
func GenerateToken(address string) (string, error)

// 3. 中间件
func JWTAuthMiddleware() rest.Middleware
```

#### 2.2 市场管理模块 (Week 4)

**功能点**:
- [ ] 市场创建
- [ ] 市场列表查询（分页、筛选、排序）
- [ ] 市场详情查询
- [ ] 市场状态管理
- [ ] 市场分类管理
- [ ] 热门市场推荐

**API接口**:
```
POST /api/v1/market/create
GET  /api/v1/market/list
GET  /api/v1/market/:id
GET  /api/v1/market/hot
GET  /api/v1/market/categories
GET  /api/v1/market/:id/stats
```

**数据模型**:
```go
type Market struct {
    ID              int64
    Question        string
    Category        string
    YesPrice        float64
    NoPrice         float64
    TotalVolume     float64
    Status          int
    // ...
}
```

#### 2.3 交易模块 (Week 5)

**功能点**:
- [ ] 创建买入/卖出订单
- [ ] 订单撮合逻辑
- [ ] 订单状态管理
- [ ] 交易历史查询
- [ ] 持仓管理
- [ ] 盈亏计算

**API接口**:
```
POST   /api/v1/trade/order
GET    /api/v1/trade/orders
DELETE /api/v1/trade/order/:id
GET    /api/v1/trade/history
GET    /api/v1/position/list
```

**核心逻辑**:
```go
// 订单撮合
func MatchOrders(buyOrder, sellOrder *Order) (*Trade, error)

// 更新持仓
func UpdatePosition(userAddress string, marketID int64, shares float64) error

// 计算盈亏
func CalculatePnL(position *Position, currentPrice float64) float64
```

#### 2.4 钱包模块 (Week 6)

**功能点**:
- [ ] 余额查询（链上+链下）
- [ ] 交易流水记录
- [ ] 充值/提现记录
- [ ] 余额变动通知

**API接口**:
```
GET  /api/v1/wallet/balance
GET  /api/v1/wallet/transactions
POST /api/v1/wallet/withdraw
```

---

### 第三阶段：AI与高级功能 (Week 7-10)

#### 3.1 AI预测模块 (Week 7-8)

**功能点**:
- [ ] AI模型接口集成（OpenAI/Claude）
- [ ] 预测结果存储
- [ ] 预测历史追踪
- [ ] 准确率统计
- [ ] 定时更新预测

**API接口**:
```
GET  /api/v1/ai/prediction/:marketId
POST /api/v1/ai/analyze
GET  /api/v1/ai/accuracy
GET  /api/v1/ai/history/:marketId
```

**实现方案**:
```go
// AI服务接口
type AIService interface {
    Predict(market *Market) (*Prediction, error)
    Analyze(marketID int64) (*Analysis, error)
}

// OpenAI实现
type OpenAIService struct {
    apiKey string
    client *openai.Client
}

// 定时任务
func ScheduleAIPrediction() {
    // 每小时更新一次预测
    ticker := time.NewTicker(1 * time.Hour)
    // ...
}
```

#### 3.2 结算模块 (Week 9)

**功能点**:
- [ ] 市场结果确认
- [ ] 自动结算触发
- [ ] 收益分配计算
- [ ] 用户领取奖励
- [ ] 结算争议处理

**API接口**:
```
POST /api/v1/settlement/settle/:marketId
GET  /api/v1/settlement/status/:marketId
POST /api/v1/settlement/claim/:marketId
```

**核心逻辑**:
```go
// 结算计算
func CalculateSettlement(market *Market) (*Settlement, error) {
    // 1. 获取市场结果
    // 2. 计算获胜方和失败方奖池
    // 3. 计算结算比例
    // 4. 分配收益
}

// 用户领取
func ClaimReward(userAddress string, marketID int64) error
```

#### 3.3 排行榜与统计 (Week 10)

**功能点**:
- [ ] 收益排行榜
- [ ] 胜率排行榜
- [ ] 交易量排行榜
- [ ] 平台统计数据
- [ ] 用户个人统计

**API接口**:
```
GET /api/v1/leaderboard/profit
GET /api/v1/leaderboard/winrate
GET /api/v1/stats/platform
GET /api/v1/stats/user/:address
```

**Redis实现**:
```go
// 使用Redis Sorted Set实现排行榜
func UpdateLeaderboard(userAddress string, profit float64) error {
    ctx := context.Background()
    return rdb.ZAdd(ctx, "leaderboard:profit:all", 
        &redis.Z{Score: profit, Member: userAddress}).Err()
}

func GetLeaderboard(limit int) ([]*LeaderboardEntry, error) {
    // ...
}
```

---

### 第四阶段：实时功能与优化 (Week 11-12)

#### 4.1 WebSocket实时推送 (Week 11)

**功能点**:
- [ ] WebSocket连接管理
- [ ] 市场价格实时推送
- [ ] 订单状态推送
- [ ] 通知消息推送
- [ ] 心跳检测

**实现方案**:
```go
// WebSocket Hub
type Hub struct {
    clients    map[*Client]bool
    broadcast  chan []byte
    register   chan *Client
    unregister chan *Client
}

// 订阅市场价格
func (c *Client) SubscribeMarket(marketID int64) {
    // ...
}

// 推送价格更新
func BroadcastPriceUpdate(marketID int64, price *Price) {
    // ...
}
```


