# æ¨¡å—0ï¼šé¡¹ç›®åŸºç¡€æ¶æ„æ­å»º - å®ç°æ–‡æ¡£

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**: é¡¹ç›®åŸºç¡€æ¶æ„æ­å»º  
**ä¼˜å…ˆçº§**: P0ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œæ‰€æœ‰æ¨¡å—çš„åŸºç¡€ï¼‰  
**é¢„è®¡å·¥æœŸ**: 2-3å¤©  
**ä¾èµ–**: æ— 

**ç›®æ ‡**: 
- æ­å»ºç¬¦åˆ go-zero è§„èŒƒçš„é¡¹ç›®ç»“æ„
- é…ç½®å¤šç¯å¢ƒæ”¯æŒï¼ˆdev/test/prodï¼‰
- é›†æˆ MySQL + Redis
- å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ã€æ—¥å¿—ã€ä¸­é—´ä»¶æœºåˆ¶
- æä¾›åŸºç¡€å·¥å…·å‡½æ•°åº“

---

## ğŸ—ï¸ é¡¹ç›®ç›®å½•ç»“æ„

```
back-end/PolyMarket/
â”œâ”€â”€ api/                          # APIå®šä¹‰æ–‡ä»¶
â”‚   â””â”€â”€ polymarket.api           # go-zero API DSLå®šä¹‰
â”‚
â”œâ”€â”€ internal/                     # å†…éƒ¨ä»£ç ï¼ˆä¸å¯¹å¤–æš´éœ²ï¼‰
â”‚   â”œâ”€â”€ config/                  # é…ç½®ç»“æ„ä½“
â”‚   â”‚   â””â”€â”€ config.go
â”‚   â”‚
â”‚   â”œâ”€â”€ handler/                 # HTTPå¤„ç†å™¨ï¼ˆè·¯ç”±å±‚ï¼‰
â”‚   â”‚   â”œâ”€â”€ routes.go           # è·¯ç”±æ³¨å†Œ
â”‚   â”‚   â””â”€â”€ health/             # å¥åº·æ£€æŸ¥
â”‚   â”‚       â””â”€â”€ health_handler.go
â”‚   â”‚
â”‚   â”œâ”€â”€ logic/                   # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â””â”€â”€ health/
â”‚   â”‚       â””â”€â”€ health_logic.go
â”‚   â”‚
â”‚   â”œâ”€â”€ svc/                     # æœåŠ¡ä¸Šä¸‹æ–‡ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
â”‚   â”‚   â””â”€â”€ service_context.go
â”‚   â”‚
â”‚   â”œâ”€â”€ types/                   # ç±»å‹å®šä¹‰ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚   â”‚   â””â”€â”€ types.go
â”‚   â”‚
â”‚   â”œâ”€â”€ model/                   # æ•°æ®æ¨¡å‹å±‚ï¼ˆGORMï¼‰
â”‚   â”‚   â”œâ”€â”€ init.go             # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ user_model.go       # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â””â”€â”€ vars.go             # å…¨å±€å˜é‡
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/              # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ cors_middleware.go  # è·¨åŸŸ
â”‚   â”‚   â”œâ”€â”€ log_middleware.go   # æ—¥å¿—
â”‚   â”‚   â””â”€â”€ recover_middleware.go # å¼‚å¸¸æ¢å¤
â”‚   â”‚
â”‚   â””â”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ response.go         # ç»Ÿä¸€å“åº”
â”‚       â”œâ”€â”€ crypto.go           # åŠ å¯†å·¥å…·
â”‚       â””â”€â”€ validator.go        # å‚æ•°éªŒè¯
â”‚
â”œâ”€â”€ etc/                         # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ polymarket-api.yaml     # å¼€å‘ç¯å¢ƒ
â”‚   â”œâ”€â”€ polymarket-api-test.yaml # æµ‹è¯•ç¯å¢ƒ
â”‚   â””â”€â”€ polymarket-api-prod.yaml # ç”Ÿäº§ç¯å¢ƒ
â”‚
â”œâ”€â”€ scripts/                     # è„šæœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ init_db.sql             # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â””â”€â”€ gen_api.sh              # APIä»£ç ç”Ÿæˆè„šæœ¬
â”‚
â”œâ”€â”€ logs/                        # æ—¥å¿—ç›®å½•
â”‚   â””â”€â”€ .gitkeep
â”‚
â”œâ”€â”€ go.mod                       # Goæ¨¡å—å®šä¹‰
â”œâ”€â”€ go.sum                       # ä¾èµ–é”å®š
â”œâ”€â”€ polymarket.go               # ä¸»å…¥å£æ–‡ä»¶
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
```

---

## ğŸ“¦ ä¾èµ–åŒ…å®‰è£…

### 1. æ ¸å¿ƒä¾èµ–

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd back-end/PolyMarket

# åˆå§‹åŒ– go.modï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
go mod init polymarket

# å®‰è£… go-zero æ¡†æ¶
go get -u github.com/zeromicro/go-zero@latest

# å®‰è£…æ•°æ®åº“é©±åŠ¨
go get -u gorm.io/gorm
go get -u gorm.io/driver/mysql

# å®‰è£… Redis å®¢æˆ·ç«¯
go get -u github.com/redis/go-redis/v9

# å®‰è£…ä»¥å¤ªåŠç›¸å…³
go get -u github.com/ethereum/go-ethereum

# å®‰è£… JWT
go get -u github.com/golang-jwt/jwt/v5

# å®‰è£…å·¥å…·åº“
go get -u github.com/google/uuid
go get -u golang.org/x/crypto
```

### 2. ä¾èµ–ç‰ˆæœ¬é”å®š

```bash
go mod tidy
```

---

## âš™ï¸ é…ç½®æ–‡ä»¶è®¾è®¡

### 1. å¼€å‘ç¯å¢ƒé…ç½® (etc/polymarket-api.yaml)

```yaml
Name: PolyMarket-api
Host: 0.0.0.0
Port: 8888
Mode: dev  # dev, test, prod

# æ—¥å¿—é…ç½®
Log:
  ServiceName: polymarket-api
  Mode: console  # console, file, volume
  Level: info    # debug, info, warn, error
  Path: logs
  KeepDays: 7
  Compress: false

# MySQL é…ç½®
MySQL:
  Host: 127.0.0.1
  Port: 3306
  User: root
  Password: your_password
  Database: polymarket
  MaxOpenConns: 100
  MaxIdleConns: 10
  ConnMaxLifetime: 3600  # ç§’

# Redis é…ç½®
Redis:
  Host: 127.0.0.1:6379
  Password: ""
  DB: 0
  PoolSize: 10

# åŒºå—é“¾é…ç½®
Blockchain:
  RpcUrl: http://127.0.0.1:8545  # æœ¬åœ° Hardhat èŠ‚ç‚¹
  ChainId: 31337
  PrivateKey: ""  # åç«¯é’±åŒ…ç§é’¥ï¼ˆç”¨äºä»£ç†äº¤æ˜“ï¼‰
  
# JWT é…ç½®
Auth:
  AccessSecret: your-access-secret-key-change-in-production
  AccessExpire: 86400  # 24å°æ—¶
  RefreshSecret: your-refresh-secret-key-change-in-production
  RefreshExpire: 604800  # 7å¤©

# ä¸šåŠ¡é…ç½®
Business:
  PlatformFeeRate: 0.02  # å¹³å°æ‰‹ç»­è´¹ç‡ 2%
  MinMarketDuration: 86400  # å¸‚åœºæœ€å°æŒç»­æ—¶é—´ 24å°æ—¶
  MaxMarketDuration: 31536000  # å¸‚åœºæœ€å¤§æŒç»­æ—¶é—´ 1å¹´
  MinLiquidity: 1000  # æœ€å°æµåŠ¨æ€§è¦æ±‚
```

---

## ğŸ”§ æ ¸å¿ƒä»£ç å®ç°

### 1. é…ç½®ç»“æ„ä½“ (internal/config/config.go)

```go
package config

import "github.com/zeromicro/go-zero/rest"

type Config struct {
	rest.RestConf
	
	MySQL      MySQLConfig
	Redis      RedisConfig
	Blockchain BlockchainConfig
	Auth       AuthConfig
	Business   BusinessConfig
}

type MySQLConfig struct {
	Host            string
	Port            int
	User            string
	Password        string
	Database        string
	MaxOpenConns    int
	MaxIdleConns    int
	ConnMaxLifetime int
}

type RedisConfig struct {
	Host     string
	Password string
	DB       int
	PoolSize int
}

type BlockchainConfig struct {
	RpcUrl     string
	ChainId    int64
	PrivateKey string
}

type AuthConfig struct {
	AccessSecret  string
	AccessExpire  int64
	RefreshSecret string
	RefreshExpire int64
}

type BusinessConfig struct {
	PlatformFeeRate   float64
	MinMarketDuration int64
	MaxMarketDuration int64
	MinLiquidity      float64
}
```

### 2. æ•°æ®åº“åˆå§‹åŒ– (internal/model/init.go)

```go
package model

import (
	"fmt"
	"time"

	"gorm.io/driver/mysql"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
	"polymarket/internal/config"
)

var DB *gorm.DB

// InitDB åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
func InitDB(c config.MySQLConfig) error {
	dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=True&loc=Local",
		c.User,
		c.Password,
		c.Host,
		c.Port,
		c.Database,
	)

	var err error
	DB, err = gorm.Open(mysql.Open(dsn), &gorm.Config{
		Logger: logger.Default.LogMode(logger.Info),
		NowFunc: func() time.Time {
			return time.Now().UTC()
		},
	})

	if err != nil {
		return fmt.Errorf("failed to connect database: %w", err)
	}

	sqlDB, err := DB.DB()
	if err != nil {
		return fmt.Errorf("failed to get database instance: %w", err)
	}

	// è®¾ç½®è¿æ¥æ± 
	sqlDB.SetMaxOpenConns(c.MaxOpenConns)
	sqlDB.SetMaxIdleConns(c.MaxIdleConns)
	sqlDB.SetConnMaxLifetime(time.Duration(c.ConnMaxLifetime) * time.Second)

	// æµ‹è¯•è¿æ¥
	if err := sqlDB.Ping(); err != nil {
		return fmt.Errorf("failed to ping database: %w", err)
	}

	return nil
}

// CloseDB å…³é—­æ•°æ®åº“è¿æ¥
func CloseDB() error {
	if DB != nil {
		sqlDB, err := DB.DB()
		if err != nil {
			return err
		}
		return sqlDB.Close()
	}
	return nil
}
```

### 3. Redis åˆå§‹åŒ– (internal/model/redis.go)

```go
package model

import (
	"context"
	"fmt"

	"github.com/redis/go-redis/v9"
	"polymarket/internal/config"
)

var RDB *redis.Client

// InitRedis åˆå§‹åŒ–Redisè¿æ¥
func InitRedis(c config.RedisConfig) error {
	RDB = redis.NewClient(&redis.Options{
		Addr:     c.Host,
		Password: c.Password,
		DB:       c.DB,
		PoolSize: c.PoolSize,
	})

	// æµ‹è¯•è¿æ¥
	ctx := context.Background()
	if err := RDB.Ping(ctx).Err(); err != nil {
		return fmt.Errorf("failed to connect redis: %w", err)
	}

	return nil
}

// CloseRedis å…³é—­Redisè¿æ¥
func CloseRedis() error {
	if RDB != nil {
		return RDB.Close()
	}
	return nil
}
```

### 4. æœåŠ¡ä¸Šä¸‹æ–‡ (internal/svc/service_context.go)

```go
package svc

import (
	"polymarket/internal/config"
	"polymarket/internal/middleware"
	"polymarket/internal/model"

	"github.com/zeromicro/go-zero/rest"
)

type ServiceContext struct {
	Config         config.Config
	CorsMiddleware rest.Middleware
	LogMiddleware  rest.Middleware
}

func NewServiceContext(c config.Config) *ServiceContext {
	// åˆå§‹åŒ–æ•°æ®åº“
	if err := model.InitDB(c.MySQL); err != nil {
		panic(err)
	}

	// åˆå§‹åŒ–Redis
	if err := model.InitRedis(c.Redis); err != nil {
		panic(err)
	}

	return &ServiceContext{
		Config:         c,
		CorsMiddleware: middleware.NewCorsMiddleware().Handle,
		LogMiddleware:  middleware.NewLogMiddleware().Handle,
	}
}
```

### 5. ç»Ÿä¸€å“åº”ç»“æ„ (internal/utils/response.go)

```go
package utils

import (
	"net/http"
	"time"

	"github.com/zeromicro/go-zero/rest/httpx"
)

// Response ç»Ÿä¸€å“åº”ç»“æ„
type Response struct {
	Code      int         `json:"code"`
	Msg       string      `json:"msg"`
	Data      interface{} `json:"data,omitempty"`
	Timestamp int64       `json:"timestamp"`
}

// é”™è¯¯ç å®šä¹‰
const (
	CodeSuccess        = 0
	CodeParamError     = 1001
	CodeUnauthorized   = 1002
	CodeForbidden      = 1003
	CodeNotFound       = 1004
	CodeServerError    = 1005
	CodeInvalidAddress = 2001
	CodeInvalidSign    = 2002
	CodeMarketNotFound = 3001
	CodeMarketClosed   = 3002
	CodeInsufficientBalance = 4001
	CodeOrderNotFound  = 4002
)

// Success æˆåŠŸå“åº”
func Success(w http.ResponseWriter, data interface{}) {
	resp := Response{
		Code:      CodeSuccess,
		Msg:       "success",
		Data:      data,
		Timestamp: time.Now().Unix(),
	}
	httpx.OkJson(w, resp)
}

// Error é”™è¯¯å“åº”
func Error(w http.ResponseWriter, code int, msg string) {
	resp := Response{
		Code:      code,
		Msg:       msg,
		Timestamp: time.Now().Unix(),
	}
	httpx.OkJson(w, resp)
}

// ParamError å‚æ•°é”™è¯¯
func ParamError(w http.ResponseWriter, msg string) {
	Error(w, CodeParamError, msg)
}

// Unauthorized æœªæˆæƒ
func Unauthorized(w http.ResponseWriter, msg string) {
	Error(w, CodeUnauthorized, msg)
}

// ServerError æœåŠ¡å™¨é”™è¯¯
func ServerError(w http.ResponseWriter, msg string) {
	Error(w, CodeServerError, msg)
}
```

### 6. CORS ä¸­é—´ä»¶ (internal/middleware/cors_middleware.go)

```go
package middleware

import (
	"net/http"
)

type CorsMiddleware struct{}

func NewCorsMiddleware() *CorsMiddleware {
	return &CorsMiddleware{}
}

func (m *CorsMiddleware) Handle(next http.HandlerFunc) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		// å…è®¸æ‰€æœ‰æ¥æºï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦é™åˆ¶ï¼‰
		w.Header().Set("Access-Control-Allow-Origin", "*")
		w.Header().Set("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
		w.Header().Set("Access-Control-Allow-Headers", "Content-Type, Authorization")
		w.Header().Set("Access-Control-Max-Age", "3600")

		// å¤„ç†é¢„æ£€è¯·æ±‚
		if r.Method == "OPTIONS" {
			w.WriteHeader(http.StatusNoContent)
			return
		}

		next(w, r)
	}
}
```

### 7. æ—¥å¿—ä¸­é—´ä»¶ (internal/middleware/log_middleware.go)

```go
package middleware

import (
	"net/http"
	"time"

	"github.com/zeromicro/go-zero/core/logx"
)

type LogMiddleware struct{}

func NewLogMiddleware() *LogMiddleware {
	return &LogMiddleware{}
}

func (m *LogMiddleware) Handle(next http.HandlerFunc) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		start := time.Now()

		// è®°å½•è¯·æ±‚ä¿¡æ¯
		logx.Infof("[%s] %s - Start", r.Method, r.URL.Path)

		// æ‰§è¡Œä¸‹ä¸€ä¸ªå¤„ç†å™¨
		next(w, r)

		// è®°å½•å“åº”æ—¶é—´
		duration := time.Since(start)
		logx.Infof("[%s] %s - Completed in %v", r.Method, r.URL.Path, duration)
	}
}
```

### 8. å¼‚å¸¸æ¢å¤ä¸­é—´ä»¶ (internal/middleware/recover_middleware.go)

```go
package middleware

import (
	"fmt"
	"net/http"
	"runtime/debug"

	"github.com/zeromicro/go-zero/core/logx"
	"polymarket/internal/utils"
)

type RecoverMiddleware struct{}

func NewRecoverMiddleware() *RecoverMiddleware {
	return &RecoverMiddleware{}
}

func (m *RecoverMiddleware) Handle(next http.HandlerFunc) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		defer func() {
			if err := recover(); err != nil {
				// è®°å½•é”™è¯¯å †æ ˆ
				logx.Errorf("Panic recovered: %v\n%s", err, debug.Stack())

				// è¿”å›æœåŠ¡å™¨é”™è¯¯
				utils.ServerError(w, fmt.Sprintf("Internal server error: %v", err))
			}
		}()

		next(w, r)
	}
}
```

### 9. å¥åº·æ£€æŸ¥ Handler (internal/handler/health/health_handler.go)

```go
package health

import (
	"net/http"

	"polymarket/internal/logic/health"
	"polymarket/internal/svc"
	"polymarket/internal/utils"
)

func HealthHandler(svcCtx *svc.ServiceContext) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		l := health.NewHealthLogic(r.Context(), svcCtx)
		resp, err := l.Health()
		if err != nil {
			utils.ServerError(w, err.Error())
			return
		}

		utils.Success(w, resp)
	}
}
```

### 10. å¥åº·æ£€æŸ¥ Logic (internal/logic/health/health_logic.go)

```go
package health

import (
	"context"

	"polymarket/internal/model"
	"polymarket/internal/svc"

	"github.com/zeromicro/go-zero/core/logx"
)

type HealthLogic struct {
	logx.Logger
	ctx    context.Context
	svcCtx *svc.ServiceContext
}

func NewHealthLogic(ctx context.Context, svcCtx *svc.ServiceContext) *HealthLogic {
	return &HealthLogic{
		Logger: logx.WithContext(ctx),
		ctx:    ctx,
		svcCtx: svcCtx,
	}
}

type HealthResponse struct {
	Status   string `json:"status"`
	Database string `json:"database"`
	Redis    string `json:"redis"`
}

func (l *HealthLogic) Health() (*HealthResponse, error) {
	resp := &HealthResponse{
		Status: "ok",
	}

	// æ£€æŸ¥æ•°æ®åº“è¿æ¥
	sqlDB, err := model.DB.DB()
	if err != nil || sqlDB.Ping() != nil {
		resp.Database = "disconnected"
	} else {
		resp.Database = "connected"
	}

	// æ£€æŸ¥Redisè¿æ¥
	if err := model.RDB.Ping(l.ctx).Err(); err != nil {
		resp.Redis = "disconnected"
	} else {
		resp.Redis = "connected"
	}

	return resp, nil
}
```

### 11. è·¯ç”±æ³¨å†Œ (internal/handler/routes.go)

```go
package handler

import (
	"net/http"

	"polymarket/internal/handler/health"
	"polymarket/internal/svc"

	"github.com/zeromicro/go-zero/rest"
)

func RegisterHandlers(server *rest.Server, serverCtx *svc.ServiceContext) {
	server.AddRoutes(
		[]rest.Route{
			{
				Method:  http.MethodGet,
				Path:    "/health",
				Handler: health.HealthHandler(serverCtx),
			},
		},
		rest.WithPrefix("/api/v1"),
	)
}
```

### 12. ä¸»å…¥å£æ–‡ä»¶ (polymarket.go)

```go
package main

import (
	"flag"
	"fmt"
	"os"
	"os/signal"
	"syscall"

	"polymarket/internal/config"
	"polymarket/internal/handler"
	"polymarket/internal/model"
	"polymarket/internal/svc"

	"github.com/zeromicro/go-zero/core/conf"
	"github.com/zeromicro/go-zero/core/logx"
	"github.com/zeromicro/go-zero/rest"
)

var configFile = flag.String("f", "etc/polymarket-api.yaml", "the config file")

func main() {
	flag.Parse()

	var c config.Config
	conf.MustLoad(*configFile, &c)

	// åˆ›å»ºæœåŠ¡ä¸Šä¸‹æ–‡
	server := rest.MustNewServer(c.RestConf)
	defer server.Stop()

	ctx := svc.NewServiceContext(c)
	handler.RegisterHandlers(server, ctx)

	// æ³¨å†Œå…¨å±€ä¸­é—´ä»¶
	server.Use(ctx.CorsMiddleware)
	server.Use(ctx.LogMiddleware)

	// ä¼˜é›…å…³é—­
	go func() {
		sigChan := make(chan os.Signal, 1)
		signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)
		<-sigChan

		logx.Info("Shutting down server...")

		// å…³é—­æ•°æ®åº“è¿æ¥
		if err := model.CloseDB(); err != nil {
			logx.Errorf("Failed to close database: %v", err)
		}

		// å…³é—­Redisè¿æ¥
		if err := model.CloseRedis(); err != nil {
			logx.Errorf("Failed to close redis: %v", err)
		}

		os.Exit(0)
	}()

	fmt.Printf("Starting server at %s:%d...\n", c.Host, c.Port)
	server.Start()
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### scripts/init_db.sql

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS polymarket
DEFAULT CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

USE polymarket;

-- ç”¨æˆ·è¡¨ï¼ˆåŸºç¡€ç‰ˆæœ¬ï¼Œåç»­æ¨¡å—ä¼šæ‰©å±•ï¼‰
CREATE TABLE IF NOT EXISTS `users` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `wallet_address` VARCHAR(42) NOT NULL COMMENT 'é’±åŒ…åœ°å€',
  `username` VARCHAR(50) DEFAULT NULL COMMENT 'ç”¨æˆ·å',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_wallet_address` (`wallet_address`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';

-- ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE IF NOT EXISTS `system_configs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'é…ç½®ID',
  `config_key` VARCHAR(100) NOT NULL COMMENT 'é…ç½®é”®',
  `config_value` TEXT NOT NULL COMMENT 'é…ç½®å€¼',
  `config_type` VARCHAR(50) DEFAULT 'string' COMMENT 'é…ç½®ç±»å‹',
  `description` TEXT DEFAULT NULL COMMENT 'æè¿°',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç³»ç»Ÿé…ç½®è¡¨';

-- æ’å…¥åˆå§‹é…ç½®
INSERT INTO system_configs (config_key, config_value, config_type, description) VALUES
('platform_fee_rate', '0.02', 'number', 'å¹³å°æ‰‹ç»­è´¹ç‡'),
('min_market_duration', '86400', 'number', 'å¸‚åœºæœ€å°æŒç»­æ—¶é—´(ç§’)'),
('max_market_duration', '31536000', 'number', 'å¸‚åœºæœ€å¤§æŒç»­æ—¶é—´(ç§’)'),
('min_liquidity', '1000', 'number', 'æœ€å°æµåŠ¨æ€§è¦æ±‚');
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. å¯åŠ¨é¡¹ç›®

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd back-end/PolyMarket

# è¿è¡Œé¡¹ç›®
go run polymarket.go -f etc/polymarket-api.yaml
```

### 2. æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8888/api/v1/health

# é¢„æœŸå“åº”
{
  "code": 0,
  "msg": "success",
  "data": {
    "status": "ok",
    "database": "connected",
    "redis": "connected"
  },
  "timestamp": 1704355200
}
```

### 3. æµ‹è¯•CORS

```bash
# æµ‹è¯•OPTIONSè¯·æ±‚
curl -X OPTIONS http://localhost:8888/api/v1/health \
  -H "Origin: http://localhost:3000" \
  -H "Access-Control-Request-Method: GET" \
  -v
```

---

## ğŸ“ å¼€å‘è„šæœ¬

### scripts/gen_api.sh

```bash
#!/bin/bash

# APIä»£ç ç”Ÿæˆè„šæœ¬
echo "Generating API code..."

cd "$(dirname "$0")/.."

goctl api go -api api/polymarket.api -dir . --style go_zero

echo "API code generated successfully!"
```

### ä½¿ç”¨æ–¹æ³•

```bash
chmod +x scripts/gen_api.sh
./scripts/gen_api.sh
```

---

## âœ… éªŒæ”¶æ ‡å‡†

å®Œæˆä»¥ä¸‹æ£€æŸ¥é¡¹å³è¡¨ç¤ºæ¨¡å—0å®Œæˆï¼š

- [ ] é¡¹ç›®ç›®å½•ç»“æ„ç¬¦åˆ go-zero è§„èŒƒ
- [ ] MySQL è¿æ¥æˆåŠŸï¼Œè¿æ¥æ± é…ç½®æ­£ç¡®
- [ ] Redis è¿æ¥æˆåŠŸ
- [ ] é…ç½®æ–‡ä»¶æ”¯æŒå¤šç¯å¢ƒï¼ˆdev/test/prodï¼‰
- [ ] ç»Ÿä¸€å“åº”æ ¼å¼æ­£å¸¸å·¥ä½œ
- [ ] CORS ä¸­é—´ä»¶æ­£å¸¸å·¥ä½œ
- [ ] æ—¥å¿—ä¸­é—´ä»¶è®°å½•è¯·æ±‚æ—¥å¿—
- [ ] å¼‚å¸¸æ¢å¤ä¸­é—´ä»¶æ•è· panic
- [ ] å¥åº·æ£€æŸ¥æ¥å£è¿”å›æ­£ç¡®çŠ¶æ€
- [ ] ä¼˜é›…å…³é—­æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] æ‰€æœ‰ä¾èµ–åŒ…å®‰è£…æˆåŠŸ
- [ ] ä»£ç æ— ç¼–è¯‘é”™è¯¯

---

## ğŸš€ ä¸‹ä¸€æ­¥

æ¨¡å—0å®Œæˆåï¼Œæˆ‘ä»¬å°†è¿›å…¥ï¼š

**æ¨¡å—1ï¼šç”¨æˆ·è®¤è¯ä¸ç®¡ç†æ¨¡å—**
- é’±åŒ…ç­¾åéªŒè¯
- JWT Token ç”Ÿæˆä¸éªŒè¯
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- ç”¨æˆ·èµ„æ–™ç®¡ç†

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **é…ç½®æ–‡ä»¶å®‰å…¨**: ç”Ÿäº§ç¯å¢ƒçš„é…ç½®æ–‡ä»¶ä¸è¦æäº¤åˆ° Git
2. **æ•°æ®åº“å¯†ç **: ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
3. **æ—¥å¿—çº§åˆ«**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `error` æˆ– `warn` çº§åˆ«
4. **CORSé…ç½®**: ç”Ÿäº§ç¯å¢ƒéœ€è¦é™åˆ¶å…è®¸çš„æ¥æº
5. **è¿æ¥æ± **: æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´è¿æ¥æ± å¤§å°


